<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    body {
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial
    }
  </style>
</head>

<body>
  <div id="chart" style="max-width:1000px;height:600px;margin:auto;margin-top:6%;"></div>
  <script>
    const files = {
      "Argentina": "data/ar_trap_monthly_counts.csv",
      "Perú": "data/pe_trap_monthly_counts.csv",
      "Uruguay": "data/ur_trap_monthly_counts.csv",
      "Colombia": "data/col_trap_monthly_counts.csv",
      "Chile": "data/cl_trap_monthly_counts.csv"
    };

    const COLORS = {
      //"Chile": "#ff4757", // rojo
      //"Argentina": "#999999", // celeste
      //"Uruguay": "#bbbbbb", // azul
      //"Perú": "#aaaaaa", // verde
      //"Colombia": "#666666"  // amarillo

      "Chile": "#f67278", // rojo
      "Argentina": "#dbcdf0", // celeste
      "Uruguay": "#c6def1", // azul
      "Perú": "#c9e4de", // verde
      "Colombia": "#faedcb"  // amarillo
    };

    function ymToDate(y, m) { return new Date(+y, +m - 1, 1); }

    async function loadCSV(url) {
      const text = await fetch(url).then(r => r.text());
      const rows = text.trim().split(/\r?\n/).map(r => r.split(","));
      const hdr = rows.shift().map(s => s.trim().toLowerCase());
      const yi = hdr.indexOf("year"), mi = hdr.indexOf("month"), pi = hdr.indexOf("pct_trap_avg");
      return rows.map(r => ({ date: ymToDate(r[yi], r[mi]), pct: +r[pi] }))
        .filter(d => d.date >= new Date(2017, 0, 1) && d.date < new Date(2022, 0, 1))
        .sort((a, b) => a.date - b.date);
    }

    (async () => {
      const annotations = [];
      const traces = [];
      for (const [country, path] of Object.entries(files)) {
        const data = await loadCSV(path);
        const color = COLORS[country] || "#444";
        traces.push({
          hoverinfo: "skip",
          name: country,
          x: data.map(d => d.date),
          y: data.map(d => d.pct),
          mode: "lines",
          line: { color, width: 2 },
          opacity: 0.95,
          showlegend: false,
        });

        const first = data[0], last = data[data.length - 1];
        if (first && last) {
          traces.push({

            hoverinfo: "skip",
            name: country + " (2017/2021)",
            x: [first.date, last.date],
            y: [first.pct, last.pct],
            mode: "markers",
            marker: { size: 3, line: { width: 2, color }, color },
            showlegend: false,
          });

          traces.push({
            name: country,
            x: [null],
            y: [null],
            mode: "lines",
            line: { color, width: 3 },
            showlegend: true
          });
        }
        if (country === "Chile" && data.length) {
          const peak = data.reduce((a, b) => (b.pct > a.pct ? b : a), data[0]);
          annotations.push({
            x: peak.date, y: peak.pct,
            xref: "x", yref: "y",
            xanchor: "left", yanchor: "bottom",
            text: `Un ${peak.pct.toFixed(1)}% del top 50 de Chile en Marzo 2020 fue musica trap`,
            font: { color, size: 12 },
            showarrow: true, arrowcolor: color, ax: 20, ay: -30,
            bgcolor: "rgba(255,255,255,0.85)", bordercolor: color
          });
        }
      }

      Plotly.newPlot("chart", traces, {
        showlegend: true,
        hoverinfo: "skip",
        title: {
          text:
            "Evolución de la popularidad del trap en Chile entre 2017 – 2021" +
            "<br><span style='font-size:14px; color:#555; font-weight:400;'>Porcentaje de canciones de trap en el Top 50 mensual de Spotify en distintos paises de latinoamérica</span>",
          x: 0.5,
          xanchor: "center",
          font: { size: 22, family: "Segoe UI Bold, Arial, sans-serif", color: "#111" }
        },
        annotations: [...annotations],
        xaxis: { title: "", tickformat: "%Y", dtick: "M12", range: [new Date(2016, 11, 11), new Date(2022, 1, 28)], },
        yaxis: { title: { text: "Porcentaje canciones de trap", standoff: 200 }, range: [0, 100], tickmode: "linear", tick0: 0, dtick: 10, tickformat: ".0f", ticksuffix: "%" },
        legend: { orientation: "h", x: 0.5, y: -0.2, xanchor: "center", itemclick: false, itemdoubleclick: false },
        margin: { l: 80, r: 80, t: 100, b: 110 }
      }, { responsive: true });
    })();

  </script>
</body>

</html>