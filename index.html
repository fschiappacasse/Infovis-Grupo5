<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    body {
      font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial
    }
  </style>
</head>

<body>
  <div id="chart" style="max-width:1000px;height:600px;margin:auto;margin-top:6%;"></div>
  <script>
    const files = {
      "Argentina": "data/ar_trap_monthly_counts.csv",
      "Chile": "data/cl_trap_monthly_counts.csv",
      "Perú": "data/pe_trap_monthly_counts.csv",
      "Uruguay": "data/ur_trap_monthly_counts.csv",
      "Colombia": "data/col_trap_monthly_counts.csv"
    };

    const COLORS = {
      "Chile": "#ff4757", // rojo
      "Argentina": "#1e90ff", // celeste
      "Uruguay": "#3742fa", // azul
      "Perú": "#2ed573", // verde
      "Colombia": "#ffa502"  // amarillo
    };

    function ymToDate(y, m) { return new Date(+y, +m - 1, 1); }

    async function loadCSV(url) {
      const text = await fetch(url).then(r => r.text());
      const rows = text.trim().split(/\r?\n/).map(r => r.split(","));
      const hdr = rows.shift().map(s => s.trim().toLowerCase());
      const yi = hdr.indexOf("year"), mi = hdr.indexOf("month"), pi = hdr.indexOf("pct_trap_avg");
      return rows.map(r => ({ date: ymToDate(r[yi], r[mi]), pct: +r[pi] }))
        .filter(d => d.date >= new Date(2017, 0, 1) && d.date < new Date(2022, 0, 1))
        .sort((a, b) => a.date - b.date);
    }

    (async () => {
      const traces = [];
      for (const [country, path] of Object.entries(files)) {
        const data = await loadCSV(path);
        const color = COLORS[country] || "#444";
        traces.push({
          hoverinfo: "skip",
          name: country,
          x: data.map(d => d.date),
          y: data.map(d => d.pct),
          mode: "lines",
          line: { color, width: 2 },
          //hovertemplate: "%{x|%b %Y}<br>%{y:.2f}% trap<extra>" + country + "</extra>"
        });

        const first = data[0], last = data[data.length - 1];
        if (first && last) {
          traces.push({
            
            hoverinfo: "skip",
            name: country + " (2017/2021)",
            x: [first.date, last.date],
            y: [first.pct, last.pct],
            mode: "markers",
            marker: { size: 4, line: { width: 2, color }, color },
            showlegend: false,
            //hovertemplate: "%{x|%b %Y}<br>%{y:.2f}% trap<extra>" + country + "</extra>"
          });
        }
      }

      Plotly.newPlot("chart", traces, { 
        hoverinfo: "skip",
        title: {
          text: "Evolución de la popularidad del trap entre 2017-2021",
          font: { size: 22, family: "Segoe UI Bold, Arial, sans-serif", color: "#111"  }
        },
        annotations: [
          {
            text: "Porcentaje de canciones de trap en el Top 50 de Spotify",
            xref: "paper",
            yref: "paper",
            x: 0.5,
            y: 1.07,      
            xanchor: "center",
            showarrow: false,
            font: { size: 14, color: "#555", family: "Segoe UI, Arial, sans-serif" }
          }
        ],
        xaxis: { title: "", tickformat: "%Y", dtick: "M12", range: [new Date(2016, 11, 11), new Date(2021, 11, 31)],   },
        yaxis: { title: {text: "Porcentaje canciones de trap", standoff: 200 }, rangemode: "tozero", tickformat: ".0f", ticksuffix: "%",  range: [-2, null]  },
        legend: { orientation: "h", x: 0.5, y: -0.2, xanchor: "center", itemclick: false, itemdoubleclick: false },
        margin: { l: 80, r: 20, t: 100, b: 50 } 
      }, { responsive: true });
    })();

  </script>
</body>

</html>